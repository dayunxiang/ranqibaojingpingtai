webpackJsonp([6],{772:function(e,t,a){a(794);var n=a(281)(a(786),a(809),null,null);n.options.__file="E:\\project\\ranqibaojingpingtai\\src\\views\\map\\Map.vue",n.esModule&&Object.keys(n.esModule).some(function(e){return"default"!==e&&"__esModule"!==e})&&console.error("named exports are not supported in *.vue files."),n.options.functional&&console.error("[vue-loader] Map.vue: functional components are not supported with templates, they should use render functions."),e.exports=n.exports},786:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={data:function(){return{bMap:null,njAreaData:[],markerData:[],areaMarkerData:[],listShow:!0,opts:{width:640,height:420,enableMessage:!0}}},methods:{bMapInit:function(){var e=new BMap.Map("map",{enableMapClick:!1});this.bMap=e,e.centerAndZoom(new BMap.Point(118.823513,32.020812),14),e.addControl(new BMap.MapTypeControl),e.setCurrentCity("南京"),e.enableScrollWheelZoom(!0),e.setMapStyle({styleJson:[{featureType:"railway",elementType:"geometry.stroke",stylers:{visibility:"off"}},{featureType:"label",elementType:"all",stylers:{}}]}),this.makePoint(e)},makePoint:function(e){var t=this;e.clearOverlays(),this.axios("device/listAllDevice?pageIndex=1&pageSize=100000").then(function(a){a.data.data.forEach(function(a,n){new Promise(function(e){t.axios("device/belong?did="+a.id).then(function(n){0==n.data.resultFlag||(a.name=n.data.belong.name,a.tel=n.data.belong.tel,t.njAreaData.map(function(t){var n="";if(a.aid==t.id){n+="江苏省 南京市 "+t.county;for(var i=0;i<t.street.length;i++)a.sid==t.street[i].id&&(n+=" "+t.street[i].street,a.address=n+" "+a.address,e())}}))}).catch(function(e){t.$Notice.error({title:"错误",desc:"获取用户信息时服务出错"})})}).then(function(){var n=new BMap.Point(a.x,a.y),i=new BMap.Icon("./img/marker1.png",new BMap.Size(39,42)),s=new BMap.Marker(n,{icon:i});s.setTitle(a.address),e.addOverlay(s),s.mesData=a,t.$set(s,"isWarn",!1),t.markerData.push(s),t.watchPoint(e,s),t.addClickHandler(e,s)})})}).catch(function(e){t.$Notice.error({title:"错误",desc:"请求设备时服务出错"})})},watchPoint:function(e,t){var a=this;clearInterval(t.setInt),t.setInt=setInterval(function(){a.axios("http://service.wanwuyun.com:8920/devicedata/"+t.mesData.seckey+"?count=1").then(function(e){var n=e.data.data;if(n.length>=1)if("2"==n[0].ALARM)if(t.infoCreateTime){var i=(new Date).getTime(),s=i-t.infoCreateTime;if(s>72e4){t.isWarn=!0,t.setAnimation(BMAP_ANIMATION_BOUNCE);var o=new BMap.Icon("./img/marker2.png",new BMap.Size(39,42),{});t.setIcon(o)}}else{t.isWarn=!0,t.setAnimation(BMAP_ANIMATION_BOUNCE);var r=new BMap.Icon("./img/marker2.png",new BMap.Size(39,42),{});t.setIcon(r)}else if("1"==n[0].ALARM);else if("0"==n[0].ALARM){t.isWarn=!1,a.$set(t,"infoCreateTime",!1),t.setAnimation(null);var c=new BMap.Icon("./img/marker1.png",new BMap.Size(39,42),{});t.setIcon(c)}}).catch(function(e){a.$Notice.error({title:"错误",desc:"监听设备时服务出错"})})},1500)},addClickHandler:function(e,t){t.addEventListener("click",function(a){var n=this;t.setAnimation(null),new Promise(function(a){n.geoUtils(e,t),a()}).then(function(){n.openInfo(e,t)})}.bind(this))},clickOpenInfo:function(e){e.isWarn=!1,e.setAnimation(null),e.infoCreateTime=(new Date).getTime(),this.openInfo(this.bMap,e,!0),this.watchPoint(this.bMap,e)},geoUtils:function(e,t){this.areaMarkerData=[];var a=[],n=new BMap.Point(t.point.lng-6e-5,t.point.lat+7e-5),i=new BMap.Point(t.point.lng+7e-5,t.point.lat+7e-5),s=new BMap.Point(t.point.lng+7e-5,t.point.lat-8e-5),o=new BMap.Point(t.point.lng-6e-5,t.point.lat-8e-5);a.push(n),a.push(i),a.push(s),a.push(o);for(var r=new BMap.Polygon(a),c=0;c<this.markerData.length;c++){var l=new BMap.Point(this.markerData[c].point.lng,this.markerData[c].point.lat);1==BMapLib.GeoUtils.isPointInPolygon(l,r)&&(this.areaMarkerData.push(this.markerData[c]),this.listShow=!0)}},openInfo:function(e,t,a){var n=this,i="",s="";new Promise(function(e){var a=[];n.axios("area/alarms?aid="+t.mesData.aid+"&pageNumber=1&pageSize=1000").then(function(n){n.data.rows.forEach(function(e,n){t.mesData.id==e.dId&&a.push(e)}),a<1?(s+='<tr><td class="time" style="text-align:center;">暂无记录</td>',e(s)):(a.forEach(function(e,n){t.mesData.id==e.dId&&(a.push(e),s+='<tr><td class="time">'+e.date.slice(0,e.date.indexOf("."))+'</td><td class="tel">推送'+e.alarmTel.replace(/,/g,"  ")+"</td></tr>")}),e(s))}).catch(function(e){n.$Notice.error({title:"错误",desc:"查询报警记录时服务出错"})})}).then(function(s){var o='<div class="deviceInfor"><div class="deviceUserInfor"><p><i class="ivu-icon icon-device"></i><b>设 备 名</b>：<span>'+t.mesData.nickname+'</span></p><p><i class="ivu-icon icon-dianhua"></i><b>联 系 方 式</b>：<span>'+t.mesData.tel+'</span></p><p><i class="ivu-icon icon-imsi"></i><b>设 备 号</b>：<span>'+t.mesData.imsi+'</span></p><p><i class="ivu-icon icon-dingwei"></i><b>地 址</b>：<span>'+t.mesData.address+'</span></p></div><div class="deviceAlarmInfor"><h3><i class="ivu-icon icon-tanhao"></i><b>报 警 记 录</b></h3><div class="alarmTableWrap"><table class="alarmTable">';if(i+=o+s+"</table><div></div></div>",n.areaMarkerData.length<=1||a){var r=new BMap.Point(t.point.lng,t.point.lat),c=new BMap.InfoWindow(i,n.opts);e.openInfoWindow(c,r),n.infoWindowOpen(c,t),n.infoWindowClose(c,t)}})},infoWindowOpen:function(e,t){e.addEventListener("open",function(e,a,n){var i=this;t.setAnimation(null),t.infoCreateTime=(new Date).getTime();var s=document.getElementsByClassName("BMap_pop")[0];t.isWarn?this.addClass(s,"active"):this.removeClass(s,"active"),this.infoWindowOpen=function(e,t){t.setAnimation(null),t.infoCreateTime=(new Date).getTime(),t.isWarn?i.addClass(s,"active"):i.removeClass(s,"active")}}.bind(this))},infoWindowClose:function(e,t){e.addEventListener("close",function(e){t.isWarn=!1;var a=new BMap.Icon("./img/marker1.png",new BMap.Size(39,42),{});t.setIcon(a)}.bind(this))},closeList:function(){this.listShow=!1},addClass:function(e,t){for(var a=e.className,n=""!=a?" ":"",i=a+n+t,s=i.split(" "),o=[],r=0;r<s.length;r++)-1==o.indexOf(s[r])&&o.push(s[r]);e.className=o.join(" ")},removeClass:function(e,t){var a=" "+e.className+" ";a=a.replace(/(\s+)/gi," ");var n=a.replace(" "+t+" "," ");n=n.replace(/(^\s+)|(\s+$)/g,""),e.className=n}},created:function(){var e=this;new Promise(function(t){e.axios.get("region/countyAndStreet",{params:{id:830}}).then(function(a){var n=a.data;n.resultFlag?t(n.data):e.$Notice.error({title:"错误",desc:"获取区域数据时出错"})}).catch(function(t){e.$Notice.error({title:"错误",desc:"获取区域数据时服务出错"})})}).then(function(t){e.njAreaData=t,e.bMapInit()})},computed:{listShows:function(){return this.areaMarkerData.length>1}},mounted:function(){},destroyed:function(){this.markerData.map(function(e){e.setInt&&clearInterval(e.setInt)})}}},794:function(e,t){},809:function(e,t,a){e.exports={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"map"},[a("div",{directives:[{name:"show",rawName:"v-show",value:e.listShows&&e.listShow,expression:"listShows&&listShow"}],staticClass:"alarmsList"},[a("div",{staticClass:"closeWrap"},[a("i",{staticClass:"ivu-icon icon-guanbi closeList",on:{click:e.closeList}})]),e._v(" "),a("div",{staticClass:"list"},[a("ul",e._l(e.areaMarkerData,function(t){return a("li",{class:{active:!!t.isWarn},on:{click:function(a){e.clickOpenInfo(t)}}},[a("p",[a("i",{staticClass:"ivu-icon icon-device"}),a("b",[e._v("设 备 名 ")]),e._v("："),a("span",[e._v(e._s(t.mesData.nickname))])]),e._v(" "),a("p",[a("i",{staticClass:"ivu-icon icon-dingwei"}),a("b",[e._v("地 址")]),e._v("："),a("span",[e._v(e._s(t.mesData.address))])])])}))])]),e._v(" "),a("div",{attrs:{id:"map"}})])},staticRenderFns:[]},e.exports.render._withStripped=!0}});