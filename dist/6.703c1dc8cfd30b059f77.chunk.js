webpackJsonp([6],{772:function(e,n,a){a(794);var t=a(281)(a(786),a(809),null,null);t.options.__file="E:\\project\\ranqibaojingpingtai\\src\\views\\map\\Map.vue",t.esModule&&Object.keys(t.esModule).some(function(e){return"default"!==e&&"__esModule"!==e})&&console.error("named exports are not supported in *.vue files."),t.options.functional&&console.error("[vue-loader] Map.vue: functional components are not supported with templates, they should use render functions."),e.exports=t.exports},786:function(e,n,a){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default={data:function(){return{bMap:null,njAreaData:[],markerData:[],areaMarkerData:[],listShow:!0,audioOnOff:0,goEasy:null,opts:{width:640,height:420,enableMessage:!0}}},watch:{audioOnOff:function(e){e<=0?document.getElementById("siren").pause():document.getElementById("siren").play()}},methods:{bMapInit:function(){var e=new BMap.Map("map",{enableMapClick:!1});this.bMap=e,e.centerAndZoom(new BMap.Point(118.823513,32.020812),14),e.addControl(new BMap.MapTypeControl),e.setCurrentCity("南京"),e.enableScrollWheelZoom(!0),e.setMapStyle({styleJson:[{featureType:"railway",elementType:"geometry.stroke",stylers:{visibility:"off"}},{featureType:"label",elementType:"all",stylers:{}}]}),this.makePoint(e)},makePoint:function(e){var n=this;e.clearOverlays(),this.axios("device/listAllDevice?pageIndex=1&pageSize=100000").then(function(a){a.data.data.forEach(function(a,t){new Promise(function(e){n.axios("device/belong?dId="+a.id).then(function(t){0==t.data.resultFlag?e():(a.name=t.data.belong.name,a.tel=t.data.belong.tel,n.njAreaData.map(function(n){var t="";if(a.aid==n.id){t+="江苏省 南京市 "+n.county;for(var i=0;i<n.street.length;i++)a.sid==n.street[i].id&&(t+=" "+n.street[i].street,a.address=t+" "+a.address,e())}}))}).catch(function(e){n.$Notice.error({title:"错误",desc:"获取用户信息时服务出错"})})}).then(function(){var t=new BMap.Point(a.x,a.y),i=new BMap.Icon("./img/marker1.png",new BMap.Size(39,42)),s=new BMap.Marker(t,{icon:i});s.setTitle(a.address),e.addOverlay(s),s.mesData=a,n.$set(s,"isWarn",!1),n.markerData.push(s),n.addClickHandler(e,s)})}),setTimeout(function(){n.watchPoint(e)},2e3)}).catch(function(e){n.$Notice.error({title:"错误",desc:"请求设备时服务出错"})})},watchPoint:function(e){var n=this;this.goEasy=new GoEasy({appkey:"BC-c9708db6dee74beb87244e4a1ce1554b"}),this.goEasy.publish({channel:"demo_channel",message:"Hello world!"}),console.log("监听开启"),this.goEasy.subscribe({channel:"gasalarm",onMessage:function(e){var a=JSON.parse(e.content);for(var t in a)!function(e){n.markerData.map(function(t){if(e==t.mesData.id)if("1"==a[e]){"warning"!=t.isWarn&&(n.audioOnOff=n.audioOnOff+1),t.isWarn="warning",t.setZIndex(1e4),t.setAnimation(BMAP_ANIMATION_BOUNCE),document.getElementById("siren").play();var i=new BMap.Icon("./img/marker2.png",new BMap.Size(39,42),{});t.setIcon(i)}else if("0"==a[e]){t.isWarn="notice";var s=new BMap.Icon("./img/marker3.png",new BMap.Size(39,42),{});t.setIcon(s)}else if("2"==a[e]){t.isWarn="normal";var o=new BMap.Icon("./img/marker1.png",new BMap.Size(39,42),{});t.setIcon(o)}})}(t)},onSuccess:function(){console.log("gasalarm订阅成功。")},onFailed:function(e){console.log("gasalarm订阅失败, 错误编码："+e.code+" 错误信息："+e.content)}})},addClickHandler:function(e,n){n.addEventListener("click",function(a){var t=this;n.setAnimation(null),new Promise(function(a){t.geoUtils(e,n),a()}).then(function(){t.openInfo(e,n)})}.bind(this))},clickOpenInfo:function(e){e.setAnimation(null),this.openInfo(this.bMap,e,!0)},geoUtils:function(e,n){this.areaMarkerData=[];var a=[],t=new BMap.Point(n.point.lng-6e-5,n.point.lat+7e-5),i=new BMap.Point(n.point.lng+7e-5,n.point.lat+7e-5),s=new BMap.Point(n.point.lng+7e-5,n.point.lat-8e-5),o=new BMap.Point(n.point.lng-6e-5,n.point.lat-8e-5);a.push(t),a.push(i),a.push(s),a.push(o);for(var r=new BMap.Polygon(a),c=0;c<this.markerData.length;c++){var l=new BMap.Point(this.markerData[c].point.lng,this.markerData[c].point.lat);1==BMapLib.GeoUtils.isPointInPolygon(l,r)&&(this.areaMarkerData.push(this.markerData[c]),this.listShow=!0)}},openInfo:function(e,n,a){var t=this,i="",s="";new Promise(function(e){var a=[];t.axios("area/alarms?aid="+n.mesData.aid+"&pageNumber=1&pageSize=1000").then(function(t){t.data.rows.forEach(function(e,t){n.mesData.id==e.dId&&a.push(e)}),a<1?(s+='<tr><td class="time" style="text-align:center;">暂无记录</td>',e(s)):(a.forEach(function(e,t){n.mesData.id==e.dId&&(a.push(e),s+='<tr><td class="time">'+e.date.slice(0,e.date.indexOf("."))+'</td><td class="tel">推送'+e.alarmTel.replace(/,/g,"  ")+"</td></tr>")}),e(s))}).catch(function(e){t.$Notice.error({title:"错误",desc:"查询报警记录时服务出错"})})}).then(function(s){var o='<div class="deviceInfor"><div class="deviceUserInfor"><p><i class="ivu-icon icon-device"></i><b>设 备 名</b>：<span>'+n.mesData.nickname+'</span></p><p><i class="ivu-icon icon-dianhua"></i><b>联 系 方 式</b>：<span>'+n.mesData.tel+'</span></p><p><i class="ivu-icon icon-imsi"></i><b>设 备 号</b>：<span>'+n.mesData.imsi+'</span></p><p><i class="ivu-icon icon-dingwei"></i><b>地 址</b>：<span>'+n.mesData.address+'</span></p></div><div class="deviceAlarmInfor"><h3><i class="ivu-icon icon-tanhao"></i><b>报 警 记 录</b></h3><div class="alarmTableWrap"><table class="alarmTable">';if(i+=o+s+"</table><div></div></div>",t.areaMarkerData.length<=1||a){var r=new BMap.Point(n.point.lng,n.point.lat),c=new BMap.InfoWindow(i,t.opts);e.openInfoWindow(c,r),t.infoWindowOpen(c,n),t.infoWindowClose(c,n)}})},infoWindowOpen:function(e,n){e.addEventListener("open",function(e,a,t){var i=this;"warning"==n.isWarn&&(this.audioOnOff=this.audioOnOff-1),n.setAnimation(null);var s=document.getElementsByClassName("BMap_pop")[0];"warning"==n.isWarn?this.addClass(s,"active"):this.removeClass(s,"active"),this.infoWindowOpen=function(e,n){"warning"==n.isWarn&&(i.audioOnOff=i.audioOnOff-1),n.setAnimation(null),"warning"==n.isWarn?i.addClass(s,"active"):i.removeClass(s,"active")}}.bind(this))},infoWindowClose:function(e,n){e.addEventListener("close",function(e){if("notice"==n.isWarn){var a=new BMap.Icon("./img/marker3.png",new BMap.Size(39,42),{});n.setIcon(a)}else{n.isWarn="normal";var t=new BMap.Icon("./img/marker1.png",new BMap.Size(39,42),{});n.setIcon(t)}}.bind(this))},closeList:function(){this.listShow=!1},addClass:function(e,n){for(var a=e.className,t=""!=a?" ":"",i=a+t+n,s=i.split(" "),o=[],r=0;r<s.length;r++)-1==o.indexOf(s[r])&&o.push(s[r]);e.className=o.join(" ")},removeClass:function(e,n){var a=" "+e.className+" ";a=a.replace(/(\s+)/gi," ");var t=a.replace(" "+n+" "," ");t=t.replace(/(^\s+)|(\s+$)/g,""),e.className=t}},created:function(){var e=this;new Promise(function(n){e.axios.get("region/countyAndStreet",{params:{id:830}}).then(function(a){var t=a.data;t.resultFlag?n(t.data):e.$Notice.error({title:"错误",desc:"获取区域数据时出错"})}).catch(function(n){e.$Notice.error({title:"错误",desc:"获取区域数据时服务出错"})})}).then(function(n){e.njAreaData=n,e.bMapInit()})},computed:{listShows:function(){return this.areaMarkerData.length>1}},mounted:function(){},destroyed:function(){this.audioOnOff=0,console.log(this.goEasy),this.goEasy&&this.goEasy.unsubscribe({channel:"gasalarm",onSuccess:function(){console.log("订阅取消成功。")},onFailed:function(e){console.log("取消订阅失败，错误编码："+e.code+" 错误信息："+e.content)}})}}},794:function(e,n){},809:function(e,n,a){e.exports={render:function(){var e=this,n=e.$createElement,a=e._self._c||n;return a("div",{staticClass:"map"},[a("div",{directives:[{name:"show",rawName:"v-show",value:e.listShows&&e.listShow,expression:"listShows&&listShow"}],staticClass:"alarmsList"},[a("div",{staticClass:"closeWrap"},[a("i",{staticClass:"ivu-icon icon-guanbi closeList",on:{click:e.closeList}})]),e._v(" "),a("div",{staticClass:"list"},[a("ul",e._l(e.areaMarkerData,function(n){return a("li",{class:n.isWarn,on:{click:function(a){e.clickOpenInfo(n)}}},[a("p",[a("i",{staticClass:"ivu-icon icon-device"}),a("b",[e._v("设 备 名 ")]),e._v("："),a("span",[e._v(e._s(n.mesData.nickname))])]),e._v(" "),a("p",[a("i",{staticClass:"ivu-icon icon-dingwei"}),a("b",[e._v("地 址")]),e._v("："),a("span",[e._v(e._s(n.mesData.address))])])])}))])]),e._v(" "),a("div",{attrs:{id:"map"}}),e._v(" "),e._m(0)])},staticRenderFns:[function(){var e=this,n=e.$createElement,a=e._self._c||n;return a("audio",{attrs:{id:"siren",loop:"loop"}},[a("source",{attrs:{src:"./source/119.wav"}}),e._v(" "),a("source",{attrs:{src:"./source/119.mp3"}}),e._v("\n      Your browser does not support the audio element.\n  ")])}]},e.exports.render._withStripped=!0}});