webpackJsonp([5],{771:function(e,t,n){n(791);var a=n(281)(n(784),n(806),null,null);a.options.__file="E:\\project\\ranqibaojingpingtai\\src\\views\\map\\Map.vue",a.esModule&&Object.keys(a.esModule).some(function(e){return"default"!==e&&"__esModule"!==e})&&console.error("named exports are not supported in *.vue files."),a.options.functional&&console.error("[vue-loader] Map.vue: functional components are not supported with templates, they should use render functions."),e.exports=a.exports},784:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={name:"map",data:function(){return{pointData:[],street:[],markers:[],rangePoint:[],markersDataList:[],listShow:!0,listShowTime:0,opts:{width:640,height:400,enableMessage:!0}}},computed:{listShows:function(){return this.markersDataList.length>1}},mounted:function(){var e=new BMap.Map("map",{enableMapClick:!1});e.centerAndZoom(new BMap.Point(118.823513,32.020812),14),e.addControl(new BMap.MapTypeControl),e.setCurrentCity("南京"),e.enableScrollWheelZoom(!0),e.setMapStyle({styleJson:[{featureType:"railway",elementType:"geometry.stroke",stylers:{visibility:"off"}},{featureType:"label",elementType:"all",stylers:{}}]}),this.makePoint(e),e.addEventListener("tilesloaded",function(){})},methods:{getBoundary:function(e){(new BMap.Boundary).get("南京市秦淮区",function(t){var n=t.boundaries.length;if(0===n)return void alert("未能获取当前输入行政区域");for(var a=[],i=0;i<n;i++){var s=new BMap.Polygon(t.boundaries[i],{strokeWeight:2,strokeColor:"#f00",fillColor:""});e.addOverlay(s),a=a.concat(s.getPath())}e.setViewport(a)})},makePoint:function(e){var t=this;e.clearOverlays(),this.axios("http://58.213.47.166:8990/area/devices?aid=2086&pageNumber=1&pageSize=10000").then(function(n){t.pointData=n.data.rows,t.pointData.forEach(function(n,a){t.axios("http://58.213.47.166:8990/device/belong?did="+n.id).then(function(e){t.$set(t.pointData[a],"name",e.data.belong.name),t.$set(t.pointData[a],"tel",e.data.belong.tel)});for(var i=0;i<t.street.length;i++)n.sid==t.street[i].sid&&t.$set(t.pointData[a],"address","江苏省 南京市 秦淮区 "+t.street[i].n+" "+t.pointData[a].address);var s=new BMap.Point(n.x,n.y),o=new BMap.Icon("./img/marker1.png",new BMap.Size(39,42)),r=new BMap.Marker(s,{icon:o});r.did=n.id,t.markers.push(r),r.setTitle(n.address),e.addOverlay(r),setTimeout(function(){this.addClickHandler(e,n,r)}.bind(t),100),t.watchPoint(e,n,r)})})},watchPoint:function(e,t,n){var a=this;clearInterval(n.setInt),n.setInt=setInterval(function(){a.axios("http://service.wanwuyun.com:8920/devicedata/"+t.seckey+"?count=1").then(function(e){if(e.data.data.length>=1&&(e.data.data[0].ALARM="2","2"==e.data.data[0].ALARM))if(n.infoCreateTime){var t=(new Date).getTime(),i=t-n.infoCreateTime;if(i>3e4){a.$set(n,"isWarn",!0),n.setAnimation(BMAP_ANIMATION_BOUNCE);var s=new BMap.Icon("./img/marker2.png",new BMap.Size(39,42),{});n.setIcon(s)}}else{a.$set(n,"isWarn",!0),n.setAnimation(BMAP_ANIMATION_BOUNCE);var o=new BMap.Icon("./img/marker2.png",new BMap.Size(39,42),{});n.setIcon(o)}})},2500)},addClickHandler:function(e,t,n){n.addEventListener("click",function(a){n.setAnimation(null),this.geoUtils(n,e,a),this.rangePoint.length<=1&&(clearInterval(n.setInt),this.openInfo(n,t,e),n.infoCreateTime=(new Date).getTime(),this.watchPoint(e,t,n))}.bind(this))},geoUtils:function(e,t,n,a){this.rangePoint=[],this.markersDataList=[];for(var i=new BMap.Point(e.point.lng,e.point.lat),s=new BMap.Circle(i,50),o=0;o<this.markers.length;o++){var r=new BMap.Point(this.markers[o].point.lng,this.markers[o].point.lat);if(1==BMapLib.GeoUtils.isPointInCircle(r,s)){for(var l=0;l<this.pointData.length;l++)this.markers[o].did==this.pointData[l].id&&(this.$set(this.pointData[l],"isWarn",this.markers[o].isWarn||!1),this.$set(this.pointData[l],"marker",this.markers[o]),this.$set(this.pointData[l],"map",t),this.markersDataList.push(this.pointData[l]),this.closeList());this.rangePoint.push(this.markers[o])}}},clickOpenInfo:function(e){this.$set(e,"isWarn",!1),e.marker.setAnimation(null),clearInterval(e.marker.setInt),this.openInfo(e.marker,e,e.map,!0),e.marker.infoCreateTime=(new Date).getTime(),this.watchPoint(e.map,e,e.marker)},openInfo:function(e,t,n,a){var i=this,s="",o="";new Promise(function(e){i.axios("http://58.213.47.166:8990/area/alarms?aid=2086&pageNumber=1&pageSize=1000").then(function(n){n.data.rows.forEach(function(e,n){t.id==e.dId&&(o+='<tr><td class="time">'+e.date.slice(0,e.date.indexOf("."))+'</td><td class="tel">推送'+e.alarmTel.replace(/,/g,"  ")+"</td></tr>")}),e(o)})}).then(function(o){var r='<div class="deviceInfor"><div class="deviceUserInfor"><p><i class="ivu-icon icon-user"></i><b>户 主</b>：<span>'+t.name+'</span></p><p><i class="ivu-icon icon-dianhua"></i><b>联 系 方 式</b>：<span>'+t.tel+'</span></p><p><i class="ivu-icon icon-device"></i><b>设 备 号</b>：<span>'+t.imsi+'</span></p><p><i class="ivu-icon icon-dingwei"></i><b>地 址</b>：<span>'+t.address+'</span></p></div><div class="deviceAlarmInfor"><h3><i class="ivu-icon icon-tanhao"></i><b>报 警 记 录</b></h3><table class="alarmTable">';if(s+=r+o+"</table></div></div>",i.rangePoint.length<=1||a){var l=new BMap.Point(e.point.lng,e.point.lat),c=new BMap.InfoWindow(s,i.opts);c.addEventListener("close",function(t){var n=new BMap.Icon("./img/marker1.png",new BMap.Size(39,42),{});e.setIcon(n)}.bind(i)),new Promise(function(e){n.openInfoWindow(c,l),e()}).then(function(){setTimeout(function(){var t=document.getElementsByClassName("BMap_pop")[0];e.isWarn?function(e,t){for(var n=e.className,a=""!=n?" ":"",i=n+a+t,s=i.split(" "),o=[],r=0;r<s.length;r++)-1==o.indexOf(s[r])&&o.push(s[r]);e.className=o.join(" ")}(t,"active"):function(e,t){var n=" "+e.className+" ";n=n.replace(/(\s+)/gi," ");var a=n.replace(" "+t+" "," ");a=a.replace(/(^\s+)|(\s+$)/g,""),e.className=a}(t,"active"),i.$set(e,"isWarn",!1)})})}})},closeList:function(){var e=this,t=void 0;this.listShow=!0,clearInterval(t),this.listShowTime=(new Date).getTime(),t=setInterval(function(){(new Date).getTime()-e.listShowTime>=3e4&&(e.listShow=!1,clearInterval(t))},1e3)}},destroyed:function(){this.markers.map(function(e){clearInterval(e.setInt)})},created:function(){var e=this;this.axios.get("http://58.213.47.166:8990/area/street?aid=2086").then(function(t){e.street=t.data})}}},791:function(e,t){},806:function(e,t,n){e.exports={render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"map"},[n("div",{staticClass:"alarmsList",on:{mouseover:e.closeList}},[n("ul",{directives:[{name:"show",rawName:"v-show",value:e.listShows&&e.listShow,expression:"listShows&&listShow"}]},e._l(e.markersDataList,function(t){return n("li",{class:{active:!!t.isWarn||!!t.marker.isWarn},on:{click:function(n){e.clickOpenInfo(t)}}},[n("p",[n("i",{staticClass:"ivu-icon icon-user"}),n("b",[e._v("户 主")]),e._v("："),n("span",[e._v(e._s(t.name))])]),e._v(" "),n("p",[n("i",{staticClass:"ivu-icon icon-device"}),n("b",[e._v("设 备 名 称")]),e._v("："),n("span",[e._v(e._s(t.nickname))])]),e._v(" "),n("p",[n("i",{staticClass:"ivu-icon icon-dingwei"}),n("b",[e._v("地 址")]),e._v("："),n("span",[e._v(e._s(t.address))])])])}))]),e._v(" "),n("div",{attrs:{id:"map"}})])},staticRenderFns:[]},e.exports.render._withStripped=!0}});